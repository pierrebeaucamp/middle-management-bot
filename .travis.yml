language: nix
sudo: required

install: |
  if [ "$(ls -A $HOME/nix-cache)" ]; then
    sudo rm -rf /nix/*
    cp -a $HOME/nix-cache/* /nix
  fi

before_cache: |
  if [ ! "$(ls -A $HOME/nix-cache)" ]; then
    cp -a /nix/* $HOME/nix-cache
  fi

cache:
  directories:
    - $HOME/nix-cache

jobs:
  include:
    - stage: Test
      name: Build
      script: nix-build -A package
    - name: Lint
      script: |
        nix-shell -A shell --run 'ln -s $NODE_PATH node_modules && npm run lint'
    - name: Terraform
      script: nix-shell -p terraform --run "terraform plan -input=false"
    - stage: Deploy
      if: branch = master
      deploy:
        provider: script
        skip_cleanup: true
        script: |
          nix-shell -p terraform \
            --run "terraform apply -input=false -auto-approve"
